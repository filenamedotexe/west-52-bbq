---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import { getCollection } from 'astro:content';
import { getBusinessInfo } from '~/utils/business';

const business = getBusinessInfo();

const metadata = {
  title: 'Menu | West 52 BBQ | Slow-Smoked Brisket, Ribs, Pulled Pork',
  description: 'View our full BBQ menu. Slow-smoked brisket, baby back ribs, pulled pork, and house-made sides. Gluten-free options available. Serving Shorewood, IL.',
};

// Get all menu items, filter to active only, and sort by category
const allMenuItems = (await getCollection('menu')).filter(item => {
  // Show item if active is true, or if active field doesn't exist (backwards compatibility)
  return item.data.active !== false;
});

// Group menu items by category
const menuByCategory = allMenuItems.reduce((acc, item) => {
  const category = item.data.category;
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(item);
  return acc;
}, {} as Record<string, typeof allMenuItems>);

// Category display names
const categoryNames: Record<string, string> = {
  'smoked-meats': 'Smoked Meats',
  'sandwiches': 'Sandwiches',
  'sides': 'Sides',
  'desserts': 'Desserts',
  'beverages': 'Beverages',
  'combo-platters': 'Combo Platters',
};

// Category order
const categoryOrder = ['smoked-meats', 'combo-platters', 'sandwiches', 'sides', 'desserts', 'beverages'];

// Helper function to get dietary tag display
function getDietaryTagBadge(tag: string) {
  const badges: Record<string, { label: string; color: string }> = {
    'gluten-free': { label: 'GF', color: 'bg-green-100 text-green-800' },
    'dairy-free': { label: 'DF', color: 'bg-blue-100 text-blue-800' },
    'vegan': { label: 'V', color: 'bg-purple-100 text-purple-800' },
    'vegetarian': { label: 'VG', color: 'bg-yellow-100 text-yellow-800' },
    'keto': { label: 'Keto', color: 'bg-red-100 text-red-800' },
    'low-carb': { label: 'LC', color: 'bg-orange-100 text-orange-800' },
    'nut-free': { label: 'NF', color: 'bg-gray-100 text-gray-800' },
  };
  return badges[tag] || { label: tag, color: 'bg-gray-100 text-gray-800' };
}
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <Hero
    tagline="Our Menu"
  >
    <Fragment slot="title">
      <span class="font-heading">Authentic Slow-Smoked BBQ</span>
      <br />
      <span class="text-primary">Smoked Low & Slow. Made Right.</span>
    </Fragment>

    <Fragment slot="subtitle">
      <span class="text-lg">
        Every dish is smoked using traditional methods perfected over 50 years.
        <span class="font-semibold">Call ahead for faster service:</span>
        <a href={`tel:${business.phoneRaw}`} class="text-primary hover:underline">{business.phone}</a>
      </span>
    </Fragment>
  </Hero>

  <!-- Menu Notice -->
  <div class="bg-burnt-orange text-white py-3">
    <div class="container mx-auto px-4 text-center">
      <p class="text-sm md:text-base">
        <strong>Hours:</strong> {business.hours.wednesday} (Wed-Sat) | {business.hours.sunday} (Sun) | {business.hours.monday} (Mon-Tue)
        <span class="mx-2">‚Ä¢</span>
        <strong>Call Ahead:</strong> {business.phone}
      </p>
    </div>
  </div>

  <!-- Menu Content -->
  <div class="container mx-auto px-4 py-12 md:py-16">
    {categoryOrder.map((categoryKey) => {
      const items = menuByCategory[categoryKey];
      if (!items || items.length === 0) return null;

      return (
        <section class="mb-16" id={categoryKey}>
          <h2 class="text-3xl md:text-4xl font-heading font-bold text-charcoal dark:text-white mb-8 border-b-4 border-primary pb-2">
            {categoryNames[categoryKey]}
          </h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {items.map((item) => (
              <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                <div class="flex flex-col md:flex-row">
                  {/* Image */}
                  <div class="md:w-48 w-full h-48 md:h-auto bg-gray-200 flex-shrink-0">
                    <img
                      src={item.data.image || '/images/menu/placeholder.svg'}
                      alt={item.data.name}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                  </div>

                  {/* Content */}
                  <div class="flex-1 p-6">
                    <div class="flex justify-between items-start mb-3">
                      <h3 class="text-xl md:text-2xl font-heading font-bold text-charcoal dark:text-white">
                        {item.data.name}
                      </h3>
                      <span class="text-2xl font-bold text-primary ml-4 flex-shrink-0">
                        ${item.data.price.toFixed(2)}
                      </span>
                    </div>

                    <p class="text-muted mb-3">
                      {item.data.description}
                    </p>

                {/* Dietary Tags */}
                {item.data.dietaryTags && item.data.dietaryTags.length > 0 && (
                  <div class="flex flex-wrap gap-2 mb-3">
                    {item.data.dietaryTags.map((tag) => {
                      const badge = getDietaryTagBadge(tag);
                      return (
                        <span class={`px-2 py-1 text-xs font-semibold rounded ${badge.color}`}>
                          {badge.label}
                        </span>
                      );
                    })}
                  </div>
                )}

                {/* Additional Info */}
                <div class="flex flex-wrap gap-4 text-sm text-muted">
                  {item.data.servingSize && (
                    <span>
                      <strong>Serving:</strong> {item.data.servingSize}
                    </span>
                  )}
                  {item.data.spicyLevel !== undefined && item.data.spicyLevel > 0 && (
                    <span>
                      <strong>Spicy:</strong> {'üå∂Ô∏è'.repeat(item.data.spicyLevel)}
                    </span>
                  )}
                  {item.data.calories && (
                    <span>
                      <strong>Cal:</strong> {item.data.calories}
                    </span>
                  )}
                  {item.data.featured && (
                    <span class="text-primary font-semibold">
                      ‚≠ê Customer Favorite
                    </span>
                  )}
                </div>

                    {/* Availability Notice */}
                    {item.data.availability && item.data.availability !== 'always' && (
                      <div class="mt-3 text-sm text-orange-600 dark:text-orange-400">
                        <strong>Available:</strong> {item.data.availability.replace('-', ' ')}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      );
    })}
  </div>

  <!-- Dietary Information Footer -->
  <div class="bg-off-white dark:bg-slate-800 py-8">
    <div class="container mx-auto px-4">
      <h3 class="text-2xl font-heading font-bold text-center mb-6">Dietary Information</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
        <div class="text-center">
          <span class="inline-block px-3 py-1 bg-green-100 text-green-800 font-semibold rounded mb-2">GF</span>
          <p class="text-sm">Gluten-Free</p>
        </div>
        <div class="text-center">
          <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 font-semibold rounded mb-2">DF</span>
          <p class="text-sm">Dairy-Free</p>
        </div>
        <div class="text-center">
          <span class="inline-block px-3 py-1 bg-purple-100 text-purple-800 font-semibold rounded mb-2">V</span>
          <p class="text-sm">Vegan</p>
        </div>
        <div class="text-center">
          <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 font-semibold rounded mb-2">VG</span>
          <p class="text-sm">Vegetarian</p>
        </div>
      </div>
      <p class="text-center text-muted mt-6 text-sm">
        All smoked meats are gluten-free. If you have dietary restrictions or allergies, please call us at {business.phone}.
      </p>
    </div>
  </div>

  <!-- Call To Action -->
  <CallToAction
    actions={[
      {
        variant: 'primary',
        text: 'Call to Order',
        href: `tel:${business.phoneRaw}`,
        icon: 'tabler:phone',
      },
      {
        variant: 'secondary',
        text: 'Catering Inquiry',
        href: '/catering',
        icon: 'tabler:truck-delivery',
      },
    ]}
  >
    <Fragment slot="title">
      Ready to Order?
    </Fragment>

    <Fragment slot="subtitle">
      Call ahead for faster service: {business.phone}
      <br class="hidden md:inline" />
      <span class="font-semibold">You Don't Have To Fight It To Bite It!</span>
    </Fragment>
  </CallToAction>
</Layout>
